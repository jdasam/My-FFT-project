<html>

<head>
    <script src="player.js"></script>
    <script src="dsp.js"></script>
    <script type="text/javascript" src="jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="chroma.js"></script>
</head>
<body>
    <input type="file" onchange="loadFile(this.files[0])">
    <input type="button" onclick="play()" value="PLAY">
    <canvas id="canvas" width="800" height="512" style="display: block; background-color: black ;"></canvas>

</body>
<script>
    //var fft = new FFT.complex(1, false);
    //fft.simple(fftOutput, audioBuffer);
    var fftResult;

    var ctx = $("#canvas").get()[0].getContext("2d");

    // create a temp canvas we use for copying
    var tempCanvas = document.createElement("canvas"),
        tempCtx = tempCanvas.getContext("2d");
    tempCanvas.width=800;
    tempCanvas.height=512;

    // used for color distribution
    var hot = new chroma.ColorScale({
        colors:['#000000', '#ff0000', '#ffff00', '#ffffff'],
        positions:[0, .25, .75, 1],
        mode:'rgb',
        limits:[0, 300]
    });

    var blackmanAlpha = 0.16
    var blackman0 = (1-blackmanAlpha)/2
    var blackman1 = 1/2
    var blackman2 = blackmanAlpha/2

    var smoothingTimeConstant = 0;


    
    var dummyArray = new Array(512);
    for (var i=0; i<512; i++){
        dummyArray[i] = 0;
    }
    




    function test(input) {
        var fft = new FFT(1024, 44100);
        fft.forward(input);
        var spectrum = fft.spectrum;
    }

    function doFFT(input){
        var result = {};
        var smoothingBuffer = dummyArray;

        for (var i=0, len = input.length % 1024; i<len; i++){
            input.push(0);
        }

        for (var i = 0, len = input.length; i<len; i = i+1024){
            var fft = new FFT(1024, 44100);
            var hop = input.slice(i, i+1024);
            hop = blackmanWindow(hop);
            fft.forward(hop);
            fft.spectrum = smoothing(fft.spectrum, smoothingBuffer);
            smoothingBuffer = fft.spectrum;
            fft.spectrum = conversionToDB(fft.spectrum);


            drawSpectrogram(fft.spectrum);
            //console.log(fft.spectrum.length);
        }

        /*
        var output =  new complex_array.ComplexArray(input.length);
        //console.log(output[100])
        for (var i=0, len = input.length; i<len; i++){
            output[i] = input.getChannelData(0)[i]
        }
        //console.log(output[100])
        var fftOutput = output.FFT();
        return fftOutput
        */
    }

    function audioToMono(input){
        var left = input.getChannelData(0);
        var right = input.getChannelData(1);
        var result = new Array(left.length);
        for (var i = 0, len = input.length; i<len; i++){
            result[i] = left[i]/2 + right[i]/2
        }
        return result
    }


    function drawSpectrogram(array) {

        // copy the current canvas onto the temp canvas
        var canvas = document.getElementById("canvas");

        tempCtx.drawImage(canvas, 0, 0, 800, 512);

        // iterate over the elements from the array
        for (var i = 0; i < array.length; i++) {
            // draw each pixel with the specific color
            var value = array[i] + 120 // add number
            ctx.fillStyle = hot.getColor(value).hex();

            // draw the line at the right side of the canvas
            ctx.fillRect(800 - 1, 512 - i, 1, 1);
        }

        // set translate on the canvas
        ctx.translate(-1, 0);
        // draw the copied image
        ctx.drawImage(tempCanvas, 0, 0, 800, 512, 0, 0, 800, 512);

        // reset the transformation matrix
        ctx.setTransform(1, 0, 0, 1, 0, 0);

    }

    function blackmanWindow(array){
        var output = new Array
        for (var i = 0, len = array.length; i<len; i++){
            output[i] = array[i] * (blackman0 - blackman1 * Math.cos(2 * Math.PI * i / len) + blackman2 * Math.cos(4 * Math.PI * i /len))
        }
        return output
    }

    function smoothing(currentArray, bufferArray){
        var output = new Array
        for (var i = 0, len = currentArray.length; i<len; i++){
            output[i] = smoothingTimeConstant * bufferArray[i] + (1 - smoothingTimeConstant) * currentArray[i]
        }
        return output
    }

    function conversionToDB(array){
        var output = new Array
        for (var i = 0, len = array.length; i<len; i++){
            output[i] = 20 * Math.log(array[i]) / Math.log(10);
        }
        //console.log(output)
        return output
    }


</script>
</html>



